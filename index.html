<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sasi Smart Group HCM Ctes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .table-header th { padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #4b5563; text-transform: uppercase; letter-spacing: 0.05em; background-color: #f9fafb; position: sticky; top: 0; z-index: 10; }
        .table-cell { padding: 0.75rem 1rem; font-size: 0.875rem; color: #1f2937; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
        .badge-faltante { background-color: #fee2e2; color: #b91c1c; }
        .badge-sobrante { background-color: #dcfce7; color: #166534; }
        .badge-cuadrado { background-color: #e0e7ff; color: #3730a3; }
        .badge-pendiente { background-color: #fef3c7; color: #92400e; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: 1px solid transparent; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .input-field { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-field:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        #toast { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 600; z-index: 9999; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(-20px); }
        #toast.show { opacity: 1; transform: translateY(0); }
        #toast.success { background-color: #22c55e; }
        #toast.error { background-color: #ef4444; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="toast"></div>

    <div class="max-w-screen-2xl mx-auto">
        <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Sasi Smart Group HCM Ctes</h1>
                <p class="text-gray-600 mt-1">Gestión a gran escala con Auditoría en Google Drive.</p>
            </div>
            <button id="btn-limpiar-datos" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i>Limpiar Datos</button>
        </header>

        <!-- Sección de Entradas de Datos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">1. Cargar Catálogo (CSV)</h2>
                <p class="text-sm text-gray-500 mb-4">Cargue su stock teórico. El archivo debe ser CSV con <strong>punto y coma (;)</strong> como separador. El sistema ignorará la cabecera.</p>
                <input type="file" id="csv-file-input" accept=".csv" class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">2. Registrar Venta</h2>
                <form id="form-ventas">
                    <div class="space-y-4">
                        <input type="text" id="venta-sku" class="input-field" placeholder="SKU del Producto" required>
                        <input type="number" id="venta-cantidad" class="input-field" placeholder="Cantidad Vendida" required min="1">
                        <button type="submit" class="btn btn-primary w-full"><i class="fa-solid fa-cart-shopping"></i>Registrar</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">3. Añadir al Conteo</h2>
                <form id="form-conteo">
                    <div class="space-y-4">
                        <input type="text" id="conteo-sku" class="input-field" placeholder="SKU del Producto" required>
                        <input type="number" id="conteo-cantidad" class="input-field" placeholder="Cantidad a AÑADIR" required min="1">
                        <button type="submit" class="btn btn-primary w-full"><i class="fa-solid fa-plus"></i>Añadir</button>
                    </div>
                </form>
            </div>
            <div class="card border-2 border-amber-400 bg-amber-50">
                <h2 class="text-xl font-semibold mb-4 text-amber-800"><i class="fa-solid fa-shield-halved"></i> 4. Corregir Stock</h2>
                <form id="form-correccion">
                    <div class="space-y-4">
                        <input type="text" id="correc-sku" class="input-field" placeholder="SKU a corregir" required>
                        <input type="number" id="correc-cantidad" class="input-field" placeholder="Nuevo Stock Físico TOTAL" required min="0">
                        <input type="email" id="correc-email" class="input-field" placeholder="Su Email para auditoría" required>
                        <input type="password" id="correc-codigo" class="input-field" placeholder="Código de Autorización" required>
                        <button type="submit" class="btn btn-primary w-full bg-amber-600 hover:bg-amber-700"><i class="fa-solid fa-pen-to-square"></i>Corregir</button>
                    </div>
                </form>
            </div>
             <div class="card border-2 border-rose-400 bg-rose-50">
                <h2 class="text-xl font-semibold mb-4 text-rose-800"><i class="fa-solid fa-undo"></i> 5. Anular Venta</h2>
                <form id="form-anulacion">
                    <div class="space-y-4">
                        <input type="text" id="anular-sku" class="input-field" placeholder="SKU de la venta a anular" required>
                        <input type="number" id="anular-cantidad" class="input-field" placeholder="Cantidad a anular" required min="1">
                        <input type="email" id="anular-email" class="input-field" placeholder="Su Email para auditoría" required>
                        <input type="password" id="anular-codigo" class="input-field" placeholder="Código de Autorización" required>
                        <button type="submit" class="btn btn-primary w-full bg-rose-600 hover:bg-rose-700"><i class="fa-solid fa-eraser"></i>Anular</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Dashboard de Reconciliación -->
        <div class="card">
             <div class="flex justify-between items-center mb-4 gap-4 flex-wrap">
                <h2 class="text-2xl font-bold text-gray-800">Dashboard de Reconciliación</h2>
                <div class="flex gap-4 items-center">
                    <input type="text" id="search-input" placeholder="Buscar por SKU o Descripción..." class="input-field w-full max-w-xs">
                    <button id="btn-descargar-csv" class="btn btn-secondary"><i class="fa-solid fa-file-csv"></i>Descargar CSV</button>
                </div>
             </div>
             <div class="overflow-x-auto max-h-[65vh]">
                <table class="w-full">
                    <thead class="table-header">
                        <tr>
                            <th>Prioridad</th><th>SKU</th><th>Estado</th><th>Dif. Auditoría</th><th>Dif. Conteo vs Teórico</th><th>Stock Final Real</th><th>Stock Teórico</th><th>Físico Contado</th><th>Total Vendido</th><th>Fecha Conteo</th><th>Fecha Venta</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-body"></tbody>
                </table>
             </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZfcjSDx2vNT7g2_W2Cz3KC0g7RqXQ6b69DAubqqndyo_jrWAmDzwlZTZf_VMpRzhvQw/exec';

        // --- DATABASE AND UI REFERENCES ---
        let stockTeorico = [], datosVentas = [], datosConteo = [];
        const formVentas = document.getElementById('form-ventas');
        const formConteo = document.getElementById('form-conteo');
        const formCorreccion = document.getElementById('form-correccion');
        const formAnulacion = document.getElementById('form-anulacion');
        const dashboardBody = document.getElementById('dashboard-body');
        const csvFileInput = document.getElementById('csv-file-input');
        const btnLimpiarDatos = document.getElementById('btn-limpiar-datos');
        const btnDescargarCSV = document.getElementById('btn-descargar-csv');
        const toastElement = document.getElementById('toast');
        const searchInput = document.getElementById('search-input');

        // --- DATA MANAGEMENT FUNCTIONS ---
        function saveData() {
            localStorage.setItem('stockTeorico', JSON.stringify(stockTeorico));
            localStorage.setItem('datosVentas', JSON.stringify(datosVentas));
            localStorage.setItem('datosConteo', JSON.stringify(datosConteo));
        }

        function loadData() {
            stockTeorico = JSON.parse(localStorage.getItem('stockTeorico')) || [];
            datosVentas = JSON.parse(localStorage.getItem('datosVentas')) || [];
            datosConteo = JSON.parse(localStorage.getItem('datosConteo')) || [];
            datosVentas.forEach(v => v.timestamp = new Date(v.timestamp));
            datosConteo.forEach(c => c.timestamp = new Date(c.timestamp));
        }

        function limpiarDatos() {
            localStorage.clear();
            stockTeorico = []; datosVentas = []; datosConteo = [];
            renderDashboard();
            showToast('Todos los datos han sido borrados.');
        }
        
        function showToast(message, type = 'success') {
            toastElement.textContent = message;
            toastElement.className = ``;
            toastElement.classList.add('show', type);
            setTimeout(() => { toastElement.classList.remove('show'); }, 3000);
        }

        function normalizarSku(sku) { return sku.toUpperCase().trim(); }

        // --- LOAD AND REGISTER LOGIC ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n').filter(row => row.trim() !== '').slice(1);
                try {
                    const nuevosProductos = rows.map(row => {
                        const columns = row.split(';');
                        if (columns.length < 3) throw new Error(`Fila inválida: ${row}`);
                        const sku = normalizarSku(columns[0]);
                        const stock = parseInt(columns[2], 10);
                        if (isNaN(stock)) throw new Error(`Stock inválido para SKU ${sku}`);
                        return { sku, descripcion: columns[1].trim(), stock };
                    });
                    stockTeorico = nuevosProductos;
                    saveData();
                    renderDashboard();
                    showToast(`Catálogo cargado con ${stockTeorico.length} productos.`);
                } catch (error) { showToast(`Error al procesar CSV: ${error.message}`, 'error'); }
            };
            reader.readAsText(file);
            csvFileInput.value = '';
        }

        function registrarVenta(event) {
            event.preventDefault();
            const skuInput = document.getElementById('venta-sku'), cantidadInput = document.getElementById('venta-cantidad');
            const sku = normalizarSku(skuInput.value);
            if (!stockTeorico.some(p => p.sku === sku)) { showToast('Error: El SKU no existe en el catálogo.', 'error'); return; }
            datosVentas.push({ timestamp: new Date(), sku: sku, cantidad: parseInt(cantidadInput.value, 10) });
            saveData(); renderDashboard(); formVentas.reset(); skuInput.focus(); showToast('Venta registrada correctamente.');
        }

        function anadirAlConteo(event) {
            event.preventDefault();
            const skuInput = document.getElementById('conteo-sku'), cantidadInput = document.getElementById('conteo-cantidad');
            const sku = normalizarSku(skuInput.value);
            if (!stockTeorico.some(p => p.sku === sku)) { showToast('Error: El SKU no existe en el catálogo.', 'error'); return; }
            datosConteo.push({ timestamp: new Date(), sku: sku, cantidad: parseInt(cantidadInput.value, 10), tipo: 'conteo' });
            saveData(); renderDashboard(); formConteo.reset(); skuInput.focus(); showToast('Cantidad añadida al conteo.');
        }

        async function sendToAudit(logData) {
            if (GOOGLE_SCRIPT_URL === 'URL_A_REEMPLAZAR') {
                showToast('Error: La URL del script de Google no está configurada.', 'error');
                return false;
            }
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                });
                showToast('Operación enviada a auditoría.');
                return true;
            } catch (error) {
                console.error('Error enviando a Google Sheets:', error);
                showToast('Error al enviar a auditoría. Ver consola.', 'error');
                return false;
            }
        }

        async function corregirConteo(event) {
            event.preventDefault();
            const skuInput = document.getElementById('correc-sku'), cantidadInput = document.getElementById('correc-cantidad'),
                  emailInput = document.getElementById('correc-email'), codigoInput = document.getElementById('correc-codigo');
            if (codigoInput.value !== '10234567') { showToast('Error: Código de autorización incorrecto.', 'error'); return; }
            const sku = normalizarSku(skuInput.value);
            if (!stockTeorico.some(p => p.sku === sku)) { showToast('Error: El SKU no existe en el catálogo.', 'error'); return; }
            const fisicoContadoActual = calcularFisicoContado(sku);
            const nuevaCantidadTotal = parseInt(cantidadInput.value, 10);
            const logData = { tipo: 'Corrección de Stock', timestamp: new Date().toISOString(), sku, email: emailInput.value, cantidadAnterior: fisicoContadoActual, cantidadNueva: nuevaCantidadTotal };
            
            const success = await sendToAudit(logData);
            if (success) {
                datosConteo.push({ timestamp: new Date(), sku, cantidad: nuevaCantidadTotal, tipo: 'modificacion', email: emailInput.value });
                saveData(); renderDashboard(); formCorreccion.reset();
            }
        }

        async function anularVenta(event) {
            event.preventDefault();
            const skuInput = document.getElementById('anular-sku'), cantidadInput = document.getElementById('anular-cantidad'),
                  emailInput = document.getElementById('anular-email'), codigoInput = document.getElementById('anular-codigo');
            if (codigoInput.value !== '10234567') { showToast('Error: Código de autorización incorrecto.', 'error'); return; }
            const sku = normalizarSku(skuInput.value);
            if (!stockTeorico.some(p => p.sku === sku)) { showToast('Error: El SKU no existe en el catálogo.', 'error'); return; }
            const cantidadAnular = parseInt(cantidadInput.value, 10);
            const logData = { tipo: 'Anulación de Venta', timestamp: new Date().toISOString(), sku, email: emailInput.value, cantidadAnterior: `N/A (Anulación de ${cantidadAnular})`, cantidadNueva: -cantidadAnular };

            const success = await sendToAudit(logData);
            if(success) {
                datosVentas.push({ timestamp: new Date(), sku, cantidad: -cantidadAnular });
                saveData(); renderDashboard(); formAnulacion.reset();
            }
        }

        // --- MAIN RENDER AND CALCULATION FUNCTIONS ---
        function calcularFisicoContado(sku) {
            const conteosSKU = datosConteo.filter(c => c.sku === sku);
            if (conteosSKU.length === 0) return 0;
            let ultimoIndiceModificacion = -1;
            for (let i = conteosSKU.length - 1; i >= 0; i--) {
                if (conteosSKU[i].tipo === 'modificacion') { ultimoIndiceModificacion = i; break; }
            }
            if (ultimoIndiceModificacion !== -1) {
                let stockBase = conteosSKU[ultimoIndiceModificacion].cantidad;
                for (let i = ultimoIndiceModificacion + 1; i < conteosSKU.length; i++) {
                    if (conteosSKU[i].tipo === 'conteo') { stockBase += conteosSKU[i].cantidad; }
                }
                return stockBase;
            } else {
                return conteosSKU.reduce((total, c) => total + c.cantidad, 0);
            }
        }

        function getDashboardData() {
            const searchTerm = searchInput.value.toUpperCase().trim();
            let motorCalculos = stockTeorico.map(producto => {
                const sku = producto.sku;
                const fisicoContado = calcularFisicoContado(sku);
                const ventasFiltradas = datosVentas.filter(v => v.sku === sku);
                const agregadoVentas = {
                    total: ventasFiltradas.reduce((sum, v) => sum + v.cantidad, 0),
                    ultimaVenta: ventasFiltradas.length > 0 ? new Date(Math.max(...ventasFiltradas.map(v => v.timestamp))) : null
                };
                const conteosFiltrados = datosConteo.filter(c => c.sku === sku);
                const ultimoConteoTimestamp = conteosFiltrados.length > 0 ? new Date(Math.max(...conteosFiltrados.map(c => c.timestamp))) : null;
                const stockTeoricoInicial = producto.stock, ventas = agregadoVentas.total;
                const horaConteo = ultimoConteoTimestamp, horaVenta = agregadoVentas.ultimaVenta;
                let stockFinalCalculado;
                if (!horaConteo) { stockFinalCalculado = stockTeoricoInicial - ventas; } 
                else if (horaVenta && horaVenta > horaConteo) { stockFinalCalculado = fisicoContado - ventas; } 
                else { stockFinalCalculado = stockTeoricoInicial - ventas; }
                let diferenciaAuditoria = horaConteo ? stockFinalCalculado - (stockTeoricoInicial - ventas) : 0;
                let diferenciaConteoDirecta = horaConteo ? fisicoContado - stockTeoricoInicial : 'N/A';
                let estadoCalculado, prioridad;
                if (!horaConteo) { estadoCalculado = 'Pendiente'; prioridad = 3; } 
                else if (diferenciaAuditoria === 0) { estadoCalculado = 'Cuadrado'; prioridad = 4; } 
                else if (diferenciaAuditoria > 0) { estadoCalculado = 'Sobrante'; prioridad = 2; } 
                else { estadoCalculado = 'Faltante'; prioridad = 1; }
                return { sku, descripcion: producto.descripcion, stockTeorico: stockTeoricoInicial, fisicoContado, ventas, horaConteo, horaVenta, diferenciaAuditoria, diferenciaConteoDirecta, stockFinalCalculado, estadoCalculado, prioridad };
            });
            if (searchTerm) {
                motorCalculos = motorCalculos.filter(item => item.sku.toUpperCase().includes(searchTerm) || item.descripcion.toUpperCase().includes(searchTerm));
            }
            motorCalculos.sort((a, b) => {
                if (a.prioridad !== b.prioridad) return a.prioridad - b.prioridad;
                return a.diferenciaAuditoria - b.diferenciaAuditoria;
            });
            return motorCalculos;
        }

        function renderDashboard() {
            const motorCalculos = getDashboardData();
            const formatFecha = (fecha) => !fecha ? 'N/A' : fecha.toLocaleString('es-AR', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });
            let rowsHtml = '';
            motorCalculos.forEach(item => {
                const estadoClass = `badge-${item.estadoCalculado.toLowerCase()}`;
                const difAuditoriaClass = item.diferenciaAuditoria < 0 ? 'text-red-600' : (item.diferenciaAuditoria > 0 ? 'text-green-600' : '');
                const difDirectaClass = typeof item.diferenciaConteoDirecta === 'number' && item.diferenciaConteoDirecta < 0 ? 'text-red-600' : (typeof item.diferenciaConteoDirecta === 'number' && item.diferenciaConteoDirecta > 0 ? 'text-green-600' : '');
                rowsHtml += `<tr><td class="table-cell font-bold text-center">${item.prioridad}</td><td class="table-cell font-semibold text-indigo-700">${item.sku}</td><td class="table-cell"><span class="badge ${estadoClass}">${item.estadoCalculado}</span></td><td class="table-cell font-semibold ${difAuditoriaClass}">${item.diferenciaAuditoria}</td><td class="table-cell font-semibold ${difDirectaClass}">${item.diferenciaConteoDirecta}</td><td class="table-cell font-bold text-lg">${item.stockFinalCalculado}</td><td class="table-cell">${item.stockTeorico}</td><td class="table-cell">${item.horaConteo ? item.fisicoContado : 'N/A'}</td><td class="table-cell">${item.ventas}</td><td class="table-cell text-sm">${formatFecha(item.horaConteo)}</td><td class="table-cell text-sm">${formatFecha(item.horaVenta)}</td></tr>`;
            });
            dashboardBody.innerHTML = rowsHtml;
        }

        function descargarCSV() {
            const data = getDashboardData();
            const headers = ["Prioridad", "SKU", "Descripción", "Estado", "Dif. Auditoría", "Dif. Conteo vs Teórico", "Stock Final Real", "Stock Teórico", "Físico Contado", "Total Vendido", "Fecha Conteo", "Fecha Venta"];
            let csvContent = headers.join(";") + "\n";

            data.forEach(item => {
                const row = [
                    item.prioridad,
                    item.sku,
                    `"${item.descripcion}"`,
                    item.estadoCalculado,
                    item.diferenciaAuditoria,
                    item.diferenciaConteoDirecta,
                    item.stockFinalCalculado,
                    item.stockTeorico,
                    item.horaConteo ? item.fisicoContado : 'N/A',
                    item.ventas,
                    item.horaConteo ? item.horaConteo.toLocaleString('es-AR') : 'N/A',
                    item.horaVenta ? item.horaVenta.toLocaleString('es-AR') : 'N/A'
                ];
                csvContent += row.join(";") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "balance_inventario.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- INITIALIZATION AND EVENT LISTENERS ---
        csvFileInput.addEventListener('change', handleFileUpload);
        formVentas.addEventListener('submit', registrarVenta);
        formConteo.addEventListener('submit', anadirAlConteo);
        formCorreccion.addEventListener('submit', corregirConteo);
        formAnulacion.addEventListener('submit', anularVenta);
        btnLimpiarDatos.addEventListener('click', limpiarDatos);
        searchInput.addEventListener('input', renderDashboard);
        btnDescargarCSV.addEventListener('click', descargarCSV);

        window.onload = () => { loadData(); renderDashboard(); };
    </script>
</body>
</html>
